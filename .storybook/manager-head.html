<link
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  rel="stylesheet"
/>
<meta
  name="description"
  content="Wavemaker ReactNative components"
  key="desc"
/>
<style>
  body {
    * {
      outline: none;
    }
  }
  @font-face {
    font-family: "neurial-grotesk-bold";
    src: url("fonts/neurialgrotesk-bold-webfont.woff2") format("woff2");
    font-weight: normal;
    font-style: normal;
  }

  @font-face {
    font-family: "neurial-grotesk-light";
    src: url("fonts/neurialgrotesk-light-webfont.woff2") format("woff2");
    font-weight: normal;
    font-style: normal;
  }

  @font-face {
    font-family: "neurial-grotesk-medium";
    src: url("fonts/neurialgrotesk-medium-webfont.woff2") format("woff2");
    font-weight: normal;
    font-style: normal;
  }

  @font-face {
    font-family: "neurial-grotesk-regular";
    src: url("fonts/neurialgrotesk-regular-webfont.woff2") format("woff2");
    font-weight: normal;
    font-style: normal;
  }

  /* Version Switcher Styles */
  .wm-version-switcher {
    padding: 10px 0px;
    margin: 4px 0 !important;
  }

  /* Make sidebar header use flexbox for ordering */
  .sidebar-container > div:first-child {
    display: flex !important;
    flex-direction: column !important;
  }

  /* Logo/branding area comes first */
  .sidebar-container > div:first-child > a:first-child,
  .sidebar-container > div:first-child > div:first-child {
    order: 1 !important;
  }

  /* Search bar comes after version switcher */
  .sidebar-container > div:first-child > form,
  .sidebar-container > div:first-child > div:has(form) {
    order: 3 !important;
  }

  .wm-version-switcher-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding-right: 7px;
  }

  .wm-framework-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: transparent;
    color: #296df6;
    font-family: "neurial-grotesk-medium", sans-serif;
  }

  .wm-version-select {
    padding: 4px 24px 4px 8px;
    border-radius: 2px;
    background: white;
    font-size: 12px;
    color: rgba(48, 48, 48, 1);
    border: none;
    cursor: pointer;
    appearance: none;
    outline: none;
    font-family: "neurial-grotesk-regular", sans-serif;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 6px center;
    background-size: 10px;
  }

  .wm-version-select:hover {
    /* border-color: #296df6; */
    background-color: rgb(226, 244, 254);
  }

  .wm-version-select:focus {
    /* border-color: #296df6; */
    box-shadow: 0 0 0 2px rgba(41, 109, 246, 0.15);
  }
  button[aria-label="Settings"] {
    order: 2;
  }
  button[aria-label="Tag filters"] {
    display: none;
  }
  .search-field + button {
    display: none;
  }

  a[href="#storybook-preview-wrapper"] {
    display: none;
  }

  button.wm-design-token-export {
    cursor: pointer;
    display: inline-flex;
    gap: 6px;
    -webkit-box-align: center;
    align-items: center;
    -webkit-box-pack: center;
    justify-content: center;
    padding: 4px;
    border: 1px solid transparent;
    height: 26px;
    width: 26px;
    text-align: center;
    text-decoration: none;
    transition-property: background, box-shadow;
    transition-duration: 150ms;
    transition-timing-function: ease-out;
    vertical-align: top;
    white-space: nowrap;
    user-select: none;
    opacity: 1;
    margin-right: 4px;
    font-size: 12px;
    font-weight: 700;
    line-height: 1;
    background: transparent;
    color: rgb(115, 130, 140);
    box-shadow: none;
    border-radius: 4px;
    flex-shrink: 0;
    position: relative;
    overflow: visible;
    z-index: 1;
  }
  button.wm-design-token-export:hover {
    background: rgba(41, 109, 246, 0.14);
    cursor: pointer;
    color: rgb(41, 109, 246);
    border-color: transparent;
  }
  button.wm-design-token-export span {
    font-size: 13px;
  }
</style>

<script type="text/javascript" ;>
  // Version configuration - update URLs when deploying
  const versionsConfig = {
    frameworkLabel: "React",
    frameworkIcon: `<svg width="14" height="14" viewBox="0 0 32 32" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><ellipse cx="16" cy="16" rx="14" ry="5.5" fill="none" stroke="currentColor" stroke-width="2"/><ellipse cx="16" cy="16" rx="14" ry="5.5" fill="none" stroke="currentColor" stroke-width="2" transform="rotate(60 16 16)"/><ellipse cx="16" cy="16" rx="14" ry="5.5" fill="none" stroke="currentColor" stroke-width="2" transform="rotate(120 16 16)"/><circle cx="16" cy="16" r="3" fill="currentColor"/></svg>`,
    versions: [
      {
        label: "11.01",
        url: "https://react-components.onwavemaker.com",
        current: true,
      },
      { label: "11.2", url: "https://react-components.onwavemaker.com" },
      // { label: "11.11", url: "https://dev-rn-components.onwavemaker.com" },
    ],
  };
  const componentIcons = {
    accordion: "fa-thin fa-bars-staggered",
    anchor: "fa-thin fa-link",
    alert: "fa-thin fa-triangle-exclamation",
    breadcrumb: "fa-thin fa-ellipsis-h",
    button: "fa-thin fa-diagram-predecessor",
    buttongroup: "fa-thin fa-bars-progress",
    barcodescanner: "fa-thin fa-barcode",
    camera: "fa-thin fa-camera",
    calendar: "fa-thin fa-calendar",
    card: "fa-thin fa-id-card",
    carousel: "fa-thin fa-sliders-h",
    chart: "fa-thin fa-chart-pie",
    checkbox: "fa-thin fa-square-check",
    checkboxset: "fa-thin fa-list-check",
    container: "fa-thing fa-square-full",
    currency: "fa-thin fa-dollar-sign",
    confirm: "fa-thing fa-circle-check",
    chips: "fa-thin fa-tag",
    design: "fa-thin fa-object-group",
    date: "fa fa-calendar-day",
    datetime: "fa fa-calendar-alt",
    form: "fa-thin fa-pen-to-square",
    fileupload: "fa-thin fa-file-upload",
    gridlayout: "fa-thing fa-table-cells",
    icon: "fa-thin fa-icons",
    label: "fa-thin fa-align-center",
    list: "fa-thin fa-list",
    lottie: "fa-thin fa-fire-flame-curved",
    liveform: "fa-thin fa-file-pen",
    linearlayout: "fa-thin fa-grip",
    login: "fa fa-sign-in-alt",
    map: "fa-thin fa-map",
    message: "fa-thin fa-message",
    menu: "fa-thin fa-circle-chevron-down",
    number: "fa fa-hashtag",
    navbar: "fa fa-bars",
    popover: "fa fa-info-circle",
    panel: "fa-thin fa-columns",
    picture: "fa-thin fa-images",
    progressbar: "fa-thin fa-bars-progress",
    progresscircle: "fa-thin fa-circle-notch",
    radioset: "fa-thin fa-circle-dot",
    rating: "fa-thin fa-star",
    search: "fa-thin fa-magnifying-glass",
    slider: "fa-thin fa-sliders",
    spinner: "fa-thin fa-spinner",
    select: "fa fa-caret-down",
    selectlocale: "fa fa-globe",
    tabs: "fa-thin fa-window-restore",
    tile: "fa-thin fa-square-poll-vertical",
    table: "fa-thin fa-table",
    text: "fa-thin fa-text-width",
    textarea: "fa-thin fa-align-left",
    time: "fa-thin fa-clock",
    toggle: "fa-thin fa-toggle-on",
    tooltip: "fa-thin fa-circle-info",
    tree: "fa-thin fa-tree",
    video: "fa-thin fa-video",
    webview: "fa-thin fa-globe",
    wizard: "fa-thin fa-circle-nodes",
    areachart: "fa fa-chart-area",
    barchart: "fa fa-chart-bar",
    bubblechart: "fa fa-circle",
    columnschart: "fa fa-chart-column",
    donutchart: "fa fa-circle-notch",
    linechart: "fa fa-chart-line",
    piechart: "fa fa-pie-chart",
    bottomsheet: "fa-thin fa-file",
  };

  document.addEventListener("DOMContentLoaded", () => {
    const injectVersionSwitcher = () => {
      // Check if already injected
      if (document.querySelector(".wm-version-switcher")) return;

      // Try multiple selectors to find the right insertion point
      let insertTarget = null;
      let insertPosition = "afterend";

      // Try 1: Find the search input container
      const searchForm = document.querySelector(".sidebar-header");
      if (searchForm) {
        insertTarget = searchForm.closest("div") || searchForm;
      }

      // Try 3: Just get the sidebar container itself
      if (!insertTarget) {
        const sidebar =
          document.querySelector(".sidebar-container") ||
          document.querySelector('[class*="Sidebar"]') ||
          document.querySelector("nav");
        if (sidebar && sidebar.firstChild) {
          insertTarget = sidebar.firstChild;
        }
      }

      if (!insertTarget) {
        console.log("WM Version Switcher: Could not find sidebar element");
        return;
      }

      // Create version switcher element
      const switcher = document.createElement("div");
      switcher.className = "wm-version-switcher";

      // Build version options HTML
      const optionsHtml = versionsConfig.versions
        .map(
          (v) =>
            `<option value="${v.url}"${v.current ? " selected" : ""}>${
              v.label
            }${v.current ? "" : ""}</option>`,
        )
        .join("");

      switcher.innerHTML = `
        <div class="wm-version-switcher-header">
          <div class="wm-framework-badge">
             ${versionsConfig.frameworkIcon}
            <span>${versionsConfig.frameworkLabel}</span>
          </div>
          <select name="version-slect" class="wm-version-select" title="Switch version">
            ${optionsHtml}
          </select>
        </div>
      `;

      // Add change handler
      const select = switcher.querySelector(".wm-version-select");
      select.addEventListener("change", (e) => {
        const url = e.target.value;
        if (url && url !== "#") {
          window.location.href = url;
        }
      });

      // Insert BEFORE the target element (above the search bar)
      insertTarget.insertAdjacentElement(insertPosition, switcher);
      console.log("WM Version Switcher: Injected above search bar");
    };

    const injectDesginTokenExpButton = () => {
      // Check if already injected
      if (document.querySelector(".wm-design-token-export")) return;

      // Try multiple selectors to find the right insertion point
      let insertTargetHeader = null;
      insertTargetHeader = document.querySelector(".sidebar-header");
      if (insertTargetHeader) {
        insertTargetHeader =
          insertTargetHeader.closest("div") || insertTargetHeader;
      }

      if (!insertTargetHeader) {
        console.log("WM Design Token Expander: Could not find header element");
        return;
      }

      // Create design token expander button
      const buttonExportds = document.createElement("button");
      buttonExportds.className = "wm-design-token-export";
      buttonExportds.innerHTML = `<span class="fa fa-cloud-arrow-up"></span>`;

      // Add click handler
      buttonExportds.addEventListener("click", () => {
        console.log("Design Tokens Export clicked");
      });

      // Insert at the end of the sidebar
      insertTargetHeader.insertAdjacentElement("beforeend", buttonExportds);
      console.log("WM Design Token Expander: Injected at the end of sidebar");
    };

    // Function to replace SVGs with FontAwesome icons
    const replaceSVGs = () => {
      const sidebarItems = document.querySelectorAll(
        '[data-nodetype="component"]:not(.icon-replaced)',
      );

      sidebarItems.forEach((sidebarItem) => {
        sidebarItem.classList.add("icon-replaced");
        const svgElement = sidebarItem.querySelector("button > div > svg");
        if (svgElement) {
          svgElement.remove();
        }

        const name = sidebarItem.getAttribute("data-item-id")?.split("-")[1];
        const iconClass = componentIcons[name] || "fa-solid fa-border-all";

        const newIcon = document.createElement("i");
        newIcon.className = `fas ${iconClass}`;
        newIcon.classList.add("css-1e3avu6");

        const target = sidebarItem.querySelector("button > div");
        if (target) {
          target.prepend(newIcon);
        }
      });
    };

    // Function to handle auto-collapse logic
    const setupAutoCollapse = () => {
      const sidebarItems = document.querySelectorAll(
        '[data-nodetype="component"]:not(.listener-added)',
      );

      // Keep track of the currently open item
      let currentOpenItem = null;

      // Find initially open item
      sidebarItems.forEach((item) => {
        if (item.querySelector('button[aria-expanded="true"]')) {
          currentOpenItem = item;
        }
      });

      sidebarItems.forEach((item) => {
        item.classList.add("listener-added");
        item.addEventListener("click", (event) => {
          const button = item.querySelector("button");
          const isExpanded = button?.getAttribute("aria-expanded") === "true";
          // If clicking the same item that's already open, let Storybook handle it
          if (currentOpenItem === item) {
            currentOpenItem = null;
            return;
          }

          // Close the previously open item if it exists
          if (currentOpenItem) {
            const prevButton = currentOpenItem.querySelector("button");
            if (prevButton) {
              prevButton.click();
            }
          }

          if (!isExpanded) {
            currentOpenItem = item;
          }
        });
      });
    };

    // MutationObserver to monitor when the sidebar is added/updated
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === "childList") {
          const sidebar = document.querySelector(".sidebar-container");
          if (sidebar) {
            injectVersionSwitcher(); // Inject version switcher
            injectDesginTokenExpButton();
            replaceSVGs(); // Replace SVGs
            setupAutoCollapse(); // Setup auto-collapse logic
          }
        }
      }
    });

    // Start observing the DOM for sidebar injection
    observer.observe(document.body, { childList: true, subtree: true });
  });
</script>
